function limpiarNombre(a){for(var e="ÃÀÁÄÂÈÉËÊÌÍÏÎÒÓÖÔÙÚÜÛãàáäâèéëêìíïîòóöôùúüûÑñÇç",t="AAAAAEEEEIIIIOOOOUUUUaaaaaeeeeiiiioooouuuunncc",i=0;i<e.length;i++)a=a.replace(e.charAt(i),t.charAt(i));var r=a.replace(/[^A-Za-z0-9 ]/g,"");return r=r.replace(/\s{2,}/g," "),r=r.replace(/\s/g,"-"),r.toLowerCase()}window.onload=function(){data.init(),ui.bindEvts(),map.init()};var ciudad,centro=new L.LatLng(40.482272,-3.361485),cadVariables=location.search.substring(1,location.search.length),cityquery="Alcalá de Henares";if(cadVariables.length>0){var arrVariables=cadVariables.split("&");for(i=0;i<arrVariables.length;i++)arrVariableActual=arrVariables[i].split("="),isNaN(parseFloat(arrVariableActual[1]))?eval(arrVariableActual[0]+"='"+unescape(arrVariableActual[1])+"';"):eval(arrVariableActual[0]+"="+arrVariableActual[1]+";");ciudad=city,"Madrid"==ciudad&&(centro=new L.LatLng(40.41075,-3.69366),cityquery="Madrid"),"AdH"==ciudad&&(centro=new L.LatLng(40.482272,-3.361485),cityquery="Alcalá de Henares"),$(".hd-menu-mas").find("a").remove(),$(".hd-menu-mas").append('<a class="hd-main" href="./formulario/?city='+ciudad+'">Añadir</a>'),$(".hd-menu-act").find("a").remove(),$(".hd-menu-act").append('<a class="hd-main-r" href="../actividades/?city='+ciudad+'">Actividades</a>')}var ui={bindEvts:function(){$("#show-sidebar").click(function(){$("#sidebar").toggleClass("act"),$("body").toggleClass("sidebarAct"),setTimeout(function(){map.data.map.invalidateSize(!0)},1200)}),$(".hd-menu-tema").delegate("a","click",function(){var a=$(this);return a.hasClass("active")?(a.parents(".hd-menu-tema").find(".active").removeClass("active").end().find(".hd-main").removeClass("active"),data.activateCategory(null)):(a.parents(".hd-menu-tema").find(".active").removeClass("active").end().find(".hd-main").addClass("active"),a.addClass("active"),data.activateCategory($(this).data("tema"))),!1}),$(".hd-menu-space").delegate("a","click",function(){var a=$(this);return a.hasClass("active")?(a.parents(".hd-menu-space").find(".active").removeClass("active").end().find(".hd-main").removeClass("active"),data.activateTipo(null)):(a.parents(".hd-menu-space").find(".active").removeClass("active").end().find(".hd-main").addClass("active"),a.addClass("active"),data.activateTipo($(this).data("tipo"))),!1}),$(".hd-menu-agent").delegate("a","click",function(){var a=$(this);return a.hasClass("active")?(a.parents(".hd-menu-agent").find(".active").removeClass("active").end().find(".hd-main").removeClass("active"),data.activateAgent(null)):(a.parents(".hd-menu-agent").find(".active").removeClass("active").end().find(".hd-main").addClass("active"),a.addClass("active"),data.activateAgent($(this).data("agente"))),!1}),$(".hd-menu-place").delegate("a","click",function(){var a=$(this),e=a[0],t=e.toString();return t=t.split("="),a.hasClass("active")?a.parents(".hd-menu-place").find(".active").removeClass("active").end().find(".hd-main").removeClass("active"):(a.parents(".hd-menu-place").find(".active").removeClass("active").end().find(".hd-main").addClass("active"),a.addClass("active")),map.cambiociudad(t[1]),!1}),$(".closeForm").click(function(){$(".bl-slide-pnl.active").removeClass("active")}),$(".openForm").click(function(){var a=$(this).data("target");$(".bl-slide-pnl.active").removeClass("active"),$(".bl-slpnl-"+a).addClass("active"),console.log("Espacio activo: "+data.data.filters.tipo)}),$(".hidebtn").click(function(){$("#sidebar").removeClass("act")})}},data={init:function(){this.data.sql.execute(map.queryer()).done(function(a){function e(a,e){return $(e).text()<$(a).text()?1:-1}var t=$(".hd-menu-agent ul").html(""),i=$(".hd-menu-space ul").html(""),r=$(".hd-menu-tema ul").html("");data.data.data=a.rows,data.data.oms=new OverlappingMarkerSpiderfier(map.data.map,{nearbyDistance:30,keepSpiderfied:!0,legWeight:0});for(var n=a.rows.length-1;n>=0;n--)a.rows[n].inicioOK=moment(a.rows[n].inicio),a.rows[n].finalOK=moment(a.rows[n]["final"]),data.drawMarker(a.rows[n]),a.rows[n].espacio&&-1==data.data.types.indexOf(a.rows[n].espacio)&&(data.data.types.push(a.rows[n].espacio),i.append('<li><a href="#" class="ic--'+limpiarNombre(a.rows[n].espacio)+'" data-tipo="'+a.rows[n].espacio+'">'+a.rows[n].espacio+"</a></li>")),a.rows[n].tematica&&-1==data.data.temas.indexOf(a.rows[n].tematica)&&(data.data.temas.push(a.rows[n].tematica),r.append('<li><a href="#" class="ic--'+limpiarNombre(a.rows[n].tematica)+'" data-tema="'+a.rows[n].tematica+'">'+a.rows[n].tematica+"</a></li>")),a.rows[n].agente&&-1==data.data.agents.indexOf(a.rows[n].agente)&&(data.data.agents.push(a.rows[n].agente),t.append('<li><a href="#" data-agente="'+a.rows[n].agente+'">'+a.rows[n].agente+"</a></li>"));$(".hd-menu-3 li").sort(e).appendTo(".hd-menu-3"),$(".hd-menu-4 li").sort(e).appendTo(".hd-menu-4"),$(".hd-menu-5 li").sort(e).appendTo(".hd-menu-5")}).error(function(a){console.log("errors:"+a)})},activateAgent:function(a){data.data.filters.age=a,data.processFilters(),console.log("Agente activo: "+data.data.filters.age)},activateCategory:function(a){data.data.filters.cat=a,data.processFilters(),console.log("Categoría activa: "+data.data.filters.cat)},activateTipo:function(a){data.data.filters.tipo=a,data.processFilters(),console.log("Espacio activo: "+data.data.filters.tipo)},processFilters:function(){for(var a=data.data.markers.length-1;a>=0;a--){var e=data.data.markers[a],t=e.options.data;data.data.filters.age&&t.agente!=data.data.filters.age?$(e._icon).addClass("disabled"):data.data.filters.cat&&t.tematica!=data.data.filters.cat?$(e._icon).addClass("disabled"):data.data.filters.tipo&&t.espacio!=data.data.filters.tipo?$(e._icon).addClass("disabled"):$(e._icon).removeClass("disabled")}},clearFilters:function(){data.data.filters=data.data.initialFilters;for(var a=data.data.markers.length-1;a>=0;a--)$(data.data.markers[a]._icon).removeClass("disabled")},drawMarker:function(a){var e=L.divIcon({iconSize:[40,40],html:'<div class="mk ic--'+limpiarNombre(a.tematica)+" ic--"+limpiarNombre(a.espacio)+'">'}),t=L.marker([a.lat,a.lon],{icon:e,data:a,title:a.title}).on("click",function(){data.openPop(a,this)});map.data.map.addLayer(t),data.data.oms.addMarker(t),data.data.markers.push(t)},openPop:function(a,e){if(data.activePop!=a){var t=0,i=$("#sidebar");$(".ini-categ");data.activePop&&(data.closePops(),t=600),data.data.popTimeout=setTimeout(function(){var t=a.address,r="";if(null!==a.ini_tef&&""!==a.ini_tef&&(r+='<i class="fa fa-phone"></i> '+a.ini_tef+"</br>"),null!==a.ini_mail&&""!==a.ini_mail&&(r+='<i class="fa fa-envelope"></i> '+a.ini_mail),null!==a.ini_web&&""!==a.ini_web&&" "!==a.ini_web&&(r+='</br><i class="fa fa-globe"></i> <a href="'+a.ini_web+'" target="_blank" > '+a.ini_web+"</a>"),null!==a.ini_twitter&&""!==a.ini_twitter){var n=a.ini_twitter.slice(1);r+='</br><i class="fa fa-twitter"></i> <a href="https://twitter.com/'+n+'" target="_blank" > '+a.ini_twitter+"</a>"}null!==a.ini_facebook&&""!==a.ini_facebook&&(r+='</br><i class="fa fa-facebook"></i> <a href="'+a.ini_facebook+'" target="_blank" > '+a.ini_facebook+"</a>"),i.find("h2").html(a.title),i.find(".ini-address").html(t),i.find("h3").html('<p><i class="fa fa-tag"></i>  '+a.tematica+'</br><i class="fa fa-umbrella"></i>  '+a.espacio+'</br><i class="fa fa-users"></i>  '+a.agente+"</p>").removeClass().addClass($(e._icon).find("div").attr("class")),i.find(".ini-desc").html(a.descr),i.find(".ini-contact").html(r),data.activePop=a,i.addClass("act")},t)}},closePops:function(){$("#sidebar").removeClass("act")},data:{sql:new cartodb.SQL({user:"alcalaconiniciativas"}),data:null,agents:[],types:[],temas:[],activePop:null,popCloseDelay:400,popTimeout:null,markers:[],filters:{age:null,cat:null,tipo:null},initialFilters:{age:null,cat:null,tipo:null}}},mad=[40.41,-3.7],adh=[40.482272,-3.361485],map={init:function(){this.data.map=L.map("map",{center:centro,zoom:14,minZoom:11}),L.tileLayer("http://a.tiles.mapbox.com/v3/madridcivic.n54hlbcl/{z}/{x}/{y}.png",{attribution:'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a> Service offered by <a href="http://cartodb.com">CartoDB</a>'}).addTo(this.data.map),setTimeout(function(){$("#contact-form").show()},1e3)},cambiociudad:function(a){var e,t;if("Madrid"==a)e=mad,t=12,cityquery="Madrid";else{if("AdH"!=a)return!1;e=adh,t=12,cityquery="Alcalá de Henares"}$(".hd-menu-mas").find("a").remove(),$(".hd-menu-mas").append('<a class="hd-main" href="./formulario/?city='+a+'">Añadir</a>'),$(".hd-menu-act").find("a").remove(),$(".hd-menu-act").append('<a class="hd-main-r" href="../actividades/?city='+a+'">Actividades</a>'),this.data.map.setView(e,t),mapa.init()},loadCartoDb:function(){this.data.map||this.init(),cartodb.createLayer(this.data.map,this.data.mapConfig).on("done",function(a){map.data.cartoLayer=a,a.getSubLayer(0).on("featureOver",function(a,e,t,i){cartodb.log.log(a,e,t,i)}),a.getSubLayer(0).infowindow.set({template:$("#infowindow_template").html(),width:350,maxHeight:400})}).on("error",function(){console.log("some error occurred")})},queryer:function(a){var e="SELECT ini_name as title, lat, lon, ini_addres as address, ini_agent as agente, ini_topic as tematica, ini_space as espacio, cartodb_id, the_geom_webmercator, ini_descri as descr, ini_tef, ini_web, ini_mail, ini_twitter, ini_facebook FROM iniciativas_aci_02_2017_n2 where city like '"+cityquery+"'";return a&&a.type&&(e+='where espacio = "'+a.type+'"'),a&&a.agent&&(e+='where agente = "'+a.agent+'"'),e},getCategory:function(a){return map.data.cartoLayer.getSubLayer(0).setSQL(map.queryer({type:a})),$("#clearFilters").show(),!1},clearCategory:function(){return $("#clearFilters").hide(),map.data.cartoLayer.getSubLayer(0).setSQL(map.queryer()),!1},data:{map:null,cartoLayer:null,mapConfig:{user_name:"alcalaconiniciativas",type:"cartodb",sublayers:[{sql:"SELECT ini_name as title, lat, lon, ini_addres as address, ini_agent as agente, ini_topic as tematica, ini_space as espacio, cartodb_id, the_geom_webmercator, ini_descri as descr, ini_tef, ini_web, ini_mail, ini_twitter, ini_facebook FROM iniciativas_aci_02_2017_n2 where city like '"+cityquery+"';"}]}}};(function(){(function(){var a={}.hasOwnProperty,e=[].slice;null!=this.L&&(this.OverlappingMarkerSpiderfier=function(){function t(e,t){var i,r,n,s,l=this;this.map=e,null==t&&(t={});for(i in t)a.call(t,i)&&(r=t[i],this[i]=r);for(this.initMarkerArrays(),this.listeners={},s=["click","zoomend"],r=0,n=s.length;n>r;r++)i=s[r],this.map.addEventListener(i,function(){return l.unspiderfy()})}var i,r;return i=t.prototype,i.VERSION="0.2.6",r=2*Math.PI,i.keepSpiderfied=!1,i.nearbyDistance=5,i.circleSpiralSwitchover=9,i.circleFootSeparation=25,i.circleStartAngle=r/12,i.spiralFootSeparation=28,i.spiralLengthStart=5,i.spiralLengthFactor=5,i.legWeight=1.5,i.legColors={usual:"#222",highlighted:"#f00"},i.initMarkerArrays=function(){return this.markers=[],this.markerListeners=[]},i.addMarker=function(a){var e,t=this;return null!=a._oms?this:(a._oms=!0,e=function(){return t.spiderListener(a)},a.addEventListener("click",e),this.markerListeners.push(e),this.markers.push(a),this)},i.getMarkers=function(){return this.markers.slice(0)},i.removeMarker=function(a){var e,t;return null!=a._omsData&&this.unspiderfy(),e=this.arrIndexOf(this.markers,a),0>e?this:(t=this.markerListeners.splice(e,1)[0],a.removeEventListener("click",t),delete a._oms,this.markers.splice(e,1),this)},i.clearMarkers=function(){var a,e,t,i,r;for(this.unspiderfy(),r=this.markers,a=t=0,i=r.length;i>t;a=++t)e=r[a],a=this.markerListeners[a],e.removeEventListener("click",a),delete e._oms;return this.initMarkerArrays(),this},i.addListener=function(a,e){var t,i;return(null!=(i=(t=this.listeners)[a])?i:t[a]=[]).push(e),this},i.removeListener=function(a,e){var t;return t=this.arrIndexOf(this.listeners[a],e),0>t||this.listeners[a].splice(t,1),this},i.clearListeners=function(a){return this.listeners[a]=[],this},i.trigger=function(){var a,t,i,r,n,s;for(t=arguments[0],a=2<=arguments.length?e.call(arguments,1):[],t=null!=(i=this.listeners[t])?i:[],s=[],r=0,n=t.length;n>r;r++)i=t[r],s.push(i.apply(null,a));return s},i.generatePtsCircle=function(a,e){var t,i,n,s,l;for(n=this.circleFootSeparation*(2+a)/r,i=r/a,l=[],t=s=0;a>=0?a>s:s>a;t=a>=0?++s:--s)t=this.circleStartAngle+t*i,l.push(new L.Point(e.x+n*Math.cos(t),e.y+n*Math.sin(t)));return l},i.generatePtsSpiral=function(a,e){var t,i,n,s,l;for(n=this.spiralLengthStart,t=0,l=[],i=s=0;a>=0?a>s:s>a;i=a>=0?++s:--s)t+=this.spiralFootSeparation/n+5e-4*i,i=new L.Point(e.x+n*Math.cos(t),e.y+n*Math.sin(t)),n+=r*this.spiralLengthFactor/t,l.push(i);return l},i.spiderListener=function(a){var e,t,i,r,n,s,l,o,c;if((e=null!=a._omsData)&&this.keepSpiderfied||this.unspiderfy(),e)return this.trigger("click",a);for(r=[],n=[],s=this.nearbyDistance*this.nearbyDistance,i=this.map.latLngToLayerPoint(a.getLatLng()),c=this.markers,l=0,o=c.length;o>l;l++)e=c[l],this.map.hasLayer(e)&&(t=this.map.latLngToLayerPoint(e.getLatLng()),this.ptDistanceSq(t,i)<s?r.push({marker:e,markerPt:t}):n.push(e));return 1===r.length?this.trigger("click",a):this.spiderfy(r,n)},i.makeHighlightListeners=function(a){var e=this;return{highlight:function(){return a._omsData.leg.setStyle({color:e.legColors.highlighted})},unhighlight:function(){return a._omsData.leg.setStyle({color:e.legColors.usual})}}},i.spiderfy=function(a,e){var t,i,r,n,s,l,o,c,d,h;return this.spiderfying=!0,h=a.length,t=this.ptAverage(function(){var e,t,i;for(i=[],e=0,t=a.length;t>e;e++)o=a[e],i.push(o.markerPt);return i}()),n=h>=this.circleSpiralSwitchover?this.generatePtsSpiral(h,t).reverse():this.generatePtsCircle(h,t),t=function(){var e,t,o,h=this;for(o=[],e=0,t=n.length;t>e;e++)r=n[e],i=this.map.layerPointToLatLng(r),d=this.minExtract(a,function(a){return h.ptDistanceSq(a.markerPt,r)}),l=d.marker,s=new L.Polyline([l.getLatLng(),i],{color:this.legColors.usual,weight:this.legWeight,clickable:!1}),this.map.addLayer(s),l._omsData={usualPosition:l.getLatLng(),leg:s},this.legColors.highlighted!==this.legColors.usual&&(c=this.makeHighlightListeners(l),l._omsData.highlightListeners=c,l.addEventListener("mouseover",c.highlight),l.addEventListener("mouseout",c.unhighlight)),l.setLatLng(i),l.setZIndexOffset(1e6),o.push(l);return o}.call(this),delete this.spiderfying,this.spiderfied=!0,this.trigger("spiderfy",t,e)},i.unspiderfy=function(a){var e,t,i,r,n,s,l;if(null==a&&(a=null),null==this.spiderfied)return this;for(this.unspiderfying=!0,r=[],i=[],l=this.markers,n=0,s=l.length;s>n;n++)e=l[n],null!=e._omsData?(this.map.removeLayer(e._omsData.leg),e!==a&&e.setLatLng(e._omsData.usualPosition),e.setZIndexOffset(0),t=e._omsData.highlightListeners,null!=t&&(e.removeEventListener("mouseover",t.highlight),e.removeEventListener("mouseout",t.unhighlight)),delete e._omsData,r.push(e)):i.push(e);return delete this.unspiderfying,delete this.spiderfied,this.trigger("unspiderfy",r,i),this},i.ptDistanceSq=function(a,e){var t,i;return t=a.x-e.x,i=a.y-e.y,t*t+i*i},i.ptAverage=function(a){var e,t,i,r,n;for(r=t=i=0,n=a.length;n>r;r++)e=a[r],t+=e.x,i+=e.y;return a=a.length,new L.Point(t/a,i/a)},i.minExtract=function(a,e){var t,i,r,n,s,l;for(r=s=0,l=a.length;l>s;r=++s)n=a[r],n=e(n),("undefined"==typeof t||null===t||i>n)&&(i=n,t=r);return a.splice(t,1)[0]},i.arrIndexOf=function(a,e){var t,i,r,n;if(null!=a.indexOf)return a.indexOf(e);for(t=r=0,n=a.length;n>r;t=++r)if(i=a[t],i===e)return t;return-1},t}())}).call(this)}).call(this);